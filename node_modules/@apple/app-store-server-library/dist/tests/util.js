"use strict";
// Copyright (c) 2023 Apple Inc. Licensed under MIT License.
Object.defineProperty(exports, "__esModule", { value: true });
exports.readFile = readFile;
exports.readBytes = readBytes;
exports.getSignedPayloadVerifier = getSignedPayloadVerifier;
exports.getSignedPayloadVerifierWithDefaultAppAppleId = getSignedPayloadVerifierWithDefaultAppAppleId;
exports.getDefaultSignedPayloadVerifier = getDefaultSignedPayloadVerifier;
exports.createSignedDataFromJson = createSignedDataFromJson;
const fs = require("fs");
const Environment_1 = require("../models/Environment");
const jws_verification_1 = require("../jws_verification");
const crypto_1 = require("crypto");
const jsonwebtoken = require("jsonwebtoken");
function readFile(path) {
    return fs.readFileSync(path, {
        encoding: 'utf8'
    });
}
function readBytes(path) {
    return fs.readFileSync(path);
}
function getSignedPayloadVerifier(environment, bundleId, appAppleId) {
    return new jws_verification_1.SignedDataVerifier([readBytes('tests/resources/certs/testCA.der')], false, environment, bundleId, appAppleId);
}
function getSignedPayloadVerifierWithDefaultAppAppleId(environment, bundleId) {
    return getSignedPayloadVerifier(environment, bundleId, 1234);
}
function getDefaultSignedPayloadVerifier() {
    return getSignedPayloadVerifierWithDefaultAppAppleId(Environment_1.Environment.LOCAL_TESTING, "com.example");
}
function createSignedDataFromJson(path) {
    const fileContents = readFile(path);
    const keyPairOptions = {
        namedCurve: 'prime256v1',
        publicKeyEncoding: {
            type: 'spki',
            format: 'pem'
        },
        privateKeyEncoding: {
            type: 'pkcs8',
            format: 'pem'
        }
    };
    const keypair = (0, crypto_1.generateKeyPairSync)("ec", keyPairOptions);
    const privateKey = keypair.privateKey;
    return jsonwebtoken.sign(fileContents, privateKey, { algorithm: 'ES256' });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3Rlc3RzL3V0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDREQUE0RDs7QUFRNUQsNEJBSUM7QUFFRCw4QkFFQztBQUVELDREQUVDO0FBRUQsc0dBRUM7QUFFRCwwRUFFQztBQUVELDREQWdCQztBQTVDRCx5QkFBeUI7QUFDekIsdURBQW9EO0FBQ3BELDBEQUF5RDtBQUN6RCxtQ0FBK0Q7QUFDL0QsNkNBQThDO0FBRTlDLFNBQWdCLFFBQVEsQ0FBQyxJQUFZO0lBQ2pDLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUU7UUFDekIsUUFBUSxFQUFFLE1BQU07S0FDbkIsQ0FBQyxDQUFBO0FBQ04sQ0FBQztBQUVELFNBQWdCLFNBQVMsQ0FBQyxJQUFZO0lBQ2xDLE9BQU8sRUFBRSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUNoQyxDQUFDO0FBRUQsU0FBZ0Isd0JBQXdCLENBQUMsV0FBd0IsRUFBRSxRQUFnQixFQUFFLFVBQWtCO0lBQ25HLE9BQU8sSUFBSSxxQ0FBa0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDNUgsQ0FBQztBQUVELFNBQWdCLDZDQUE2QyxDQUFDLFdBQXdCLEVBQUUsUUFBZ0I7SUFDcEcsT0FBTyx3QkFBd0IsQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ2hFLENBQUM7QUFFRCxTQUFnQiwrQkFBK0I7SUFDM0MsT0FBTyw2Q0FBNkMsQ0FBQyx5QkFBVyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQTtBQUNsRyxDQUFDO0FBRUQsU0FBZ0Isd0JBQXdCLENBQUMsSUFBWTtJQUNqRCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDbkMsTUFBTSxjQUFjLEdBQW1DO1FBQ25ELFVBQVUsRUFBRSxZQUFZO1FBQ3hCLGlCQUFpQixFQUFFO1lBQ2YsSUFBSSxFQUFFLE1BQU07WUFDWixNQUFNLEVBQUUsS0FBSztTQUNoQjtRQUNELGtCQUFrQixFQUFFO1lBQ2hCLElBQUksRUFBRSxPQUFPO1lBQ2IsTUFBTSxFQUFFLEtBQUs7U0FDaEI7S0FDSixDQUFBO0lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBQSw0QkFBbUIsRUFBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUE7SUFDekQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQTtJQUNyQyxPQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDO0FBQzlFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIDIwMjMgQXBwbGUgSW5jLiBMaWNlbnNlZCB1bmRlciBNSVQgTGljZW5zZS5cblxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tICcuLi9tb2RlbHMvRW52aXJvbm1lbnQnO1xuaW1wb3J0IHsgU2lnbmVkRGF0YVZlcmlmaWVyIH0gZnJvbSAnLi4vandzX3ZlcmlmaWNhdGlvbic7XG5pbXBvcnQgeyBFQ0tleVBhaXJPcHRpb25zLCBnZW5lcmF0ZUtleVBhaXJTeW5jIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBqc29ud2VidG9rZW4gPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGaWxlKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLCB7XG4gICAgICAgIGVuY29kaW5nOiAndXRmOCdcbiAgICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVhZEJ5dGVzKHBhdGg6IHN0cmluZyk6IEJ1ZmZlciB7XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2lnbmVkUGF5bG9hZFZlcmlmaWVyKGVudmlyb25tZW50OiBFbnZpcm9ubWVudCwgYnVuZGxlSWQ6IHN0cmluZywgYXBwQXBwbGVJZDogbnVtYmVyKTogU2lnbmVkRGF0YVZlcmlmaWVyIHtcbiAgICByZXR1cm4gbmV3IFNpZ25lZERhdGFWZXJpZmllcihbcmVhZEJ5dGVzKCd0ZXN0cy9yZXNvdXJjZXMvY2VydHMvdGVzdENBLmRlcicpXSwgZmFsc2UsIGVudmlyb25tZW50LCBidW5kbGVJZCwgYXBwQXBwbGVJZClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNpZ25lZFBheWxvYWRWZXJpZmllcldpdGhEZWZhdWx0QXBwQXBwbGVJZChlbnZpcm9ubWVudDogRW52aXJvbm1lbnQsIGJ1bmRsZUlkOiBzdHJpbmcpOiBTaWduZWREYXRhVmVyaWZpZXIge1xuICAgIHJldHVybiBnZXRTaWduZWRQYXlsb2FkVmVyaWZpZXIoZW52aXJvbm1lbnQsIGJ1bmRsZUlkLCAxMjM0KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdFNpZ25lZFBheWxvYWRWZXJpZmllcigpOiBTaWduZWREYXRhVmVyaWZpZXIge1xuICAgIHJldHVybiBnZXRTaWduZWRQYXlsb2FkVmVyaWZpZXJXaXRoRGVmYXVsdEFwcEFwcGxlSWQoRW52aXJvbm1lbnQuTE9DQUxfVEVTVElORywgXCJjb20uZXhhbXBsZVwiKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2lnbmVkRGF0YUZyb21Kc29uKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgZmlsZUNvbnRlbnRzID0gcmVhZEZpbGUocGF0aClcbiAgICBjb25zdCBrZXlQYWlyT3B0aW9uczogRUNLZXlQYWlyT3B0aW9uczwncGVtJywgJ3BlbSc+ID0ge1xuICAgICAgICBuYW1lZEN1cnZlOiAncHJpbWUyNTZ2MScsXG4gICAgICAgIHB1YmxpY0tleUVuY29kaW5nOiB7XG4gICAgICAgICAgICB0eXBlOiAnc3BraScsXG4gICAgICAgICAgICBmb3JtYXQ6ICdwZW0nXG4gICAgICAgIH0sXG4gICAgICAgIHByaXZhdGVLZXlFbmNvZGluZzoge1xuICAgICAgICAgICAgdHlwZTogJ3BrY3M4JyxcbiAgICAgICAgICAgIGZvcm1hdDogJ3BlbSdcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBrZXlwYWlyID0gZ2VuZXJhdGVLZXlQYWlyU3luYyhcImVjXCIsIGtleVBhaXJPcHRpb25zKVxuICAgIGNvbnN0IHByaXZhdGVLZXkgPSBrZXlwYWlyLnByaXZhdGVLZXlcbiAgICByZXR1cm4ganNvbndlYnRva2VuLnNpZ24oZmlsZUNvbnRlbnRzLCBwcml2YXRlS2V5LCB7IGFsZ29yaXRobTogJ0VTMjU2J30pO1xufSJdfQ==