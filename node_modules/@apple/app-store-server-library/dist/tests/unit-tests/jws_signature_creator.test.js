"use strict";
// Copyright (c) 2025 Apple Inc. Licensed under MIT License.
Object.defineProperty(exports, "__esModule", { value: true });
const jws_signature_creator_1 = require("../../jws_signature_creator");
const util_1 = require("../util");
describe("JWS Signature Creator Checks", () => {
    it('should create a promotional offer signature', async () => {
        const signatureCreator = new jws_signature_creator_1.PromotionalOfferV2SignatureCreator((0, util_1.readFile)('tests/resources/certs/testSigningKey.p8'), "keyId", "issuerId", "bundleId");
        const signature = signatureCreator.createSignature('productId', 'offerIdentifier', 'transactionId');
        expect(signature).toBeTruthy();
        let header = JSON.parse(Buffer.from(signature.split('.')[0], 'base64url').toString());
        let payload = JSON.parse(Buffer.from(signature.split('.')[1], 'base64url').toString());
        // Header
        expect('JWT').toBe(header['typ']);
        expect('ES256').toBe(header['alg']);
        expect('keyId').toBe(header['kid']);
        // Payload
        expect('issuerId').toBe(payload['iss']);
        expect(payload['iat']).toBeTruthy();
        expect(payload['exp']).toBeUndefined();
        expect('promotional-offer').toBe(payload['aud']);
        expect('bundleId').toBe(payload['bid']);
        expect(payload['nonce']).toBeTruthy();
        expect('productId').toBe(payload['productId']);
        expect('offerIdentifier').toBe(payload['offerIdentifier']);
        expect('transactionId').toBe(payload['transactionId']);
    });
    it('should create a promotional offer signature without a transaction id', async () => {
        const signatureCreator = new jws_signature_creator_1.PromotionalOfferV2SignatureCreator((0, util_1.readFile)('tests/resources/certs/testSigningKey.p8'), "keyId", "issuerId", "bundleId");
        const signature = signatureCreator.createSignature('productId', 'offerIdentifier');
        let payload = JSON.parse(Buffer.from(signature.split('.')[1], 'base64url').toString());
        expect(payload['transactionId']).toBeUndefined();
    });
    it('should create a introductory eligibility offer signature', async () => {
        const signatureCreator = new jws_signature_creator_1.IntroductoryOfferEligibilitySignatureCreator((0, util_1.readFile)('tests/resources/certs/testSigningKey.p8'), "keyId", "issuerId", "bundleId");
        const signature = signatureCreator.createSignature('productId', true, 'transactionId');
        expect(signature).toBeTruthy();
        let header = JSON.parse(Buffer.from(signature.split('.')[0], 'base64url').toString());
        let payload = JSON.parse(Buffer.from(signature.split('.')[1], 'base64url').toString());
        // Header
        expect('JWT').toBe(header['typ']);
        expect('ES256').toBe(header['alg']);
        expect('keyId').toBe(header['kid']);
        // Payload
        expect('issuerId').toBe(payload['iss']);
        expect(payload['iat']).toBeTruthy();
        expect(payload['exp']).toBeUndefined();
        expect('introductory-offer-eligibility').toBe(payload['aud']);
        expect('bundleId').toBe(payload['bid']);
        expect(payload['nonce']).toBeTruthy();
        expect('productId').toBe(payload['productId']);
        expect(true).toBe(payload['allowIntroductoryOffer']);
        expect('transactionId').toBe(payload['transactionId']);
    });
    it('should create an Advanced Commerce in app signature', async () => {
        const signatureCreator = new jws_signature_creator_1.AdvancedCommerceInAppSignatureCreator((0, util_1.readFile)('tests/resources/certs/testSigningKey.p8'), "keyId", "issuerId", "bundleId");
        let request = {
            testValue: "testValue"
        };
        const signature = signatureCreator.createSignature(request);
        expect(signature).toBeTruthy();
        let header = JSON.parse(Buffer.from(signature.split('.')[0], 'base64url').toString());
        let payload = JSON.parse(Buffer.from(signature.split('.')[1], 'base64url').toString());
        // Header
        expect('JWT').toBe(header['typ']);
        expect('ES256').toBe(header['alg']);
        expect('keyId').toBe(header['kid']);
        // Payload
        expect('issuerId').toBe(payload['iss']);
        expect(payload['iat']).toBeTruthy();
        expect(payload['exp']).toBeUndefined();
        expect('advanced-commerce-api').toBe(payload['aud']);
        expect('bundleId').toBe(payload['bid']);
        expect(payload['nonce']).toBeTruthy();
        let parsedRequestJson = Buffer.from(payload['request'], 'base64').toString('utf-8');
        let parsedRequest = JSON.parse(parsedRequestJson);
        expect(parsedRequest['testValue']).toBe('testValue');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiandzX3NpZ25hdHVyZV9jcmVhdG9yLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90ZXN0cy91bml0LXRlc3RzL2p3c19zaWduYXR1cmVfY3JlYXRvci50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0REFBNEQ7O0FBRTVELHVFQUFvTTtBQUNwTSxrQ0FBa0M7QUFPbEMsUUFBUSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtJQUMxQyxFQUFFLENBQUMsNkNBQTZDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDekQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLDBEQUFrQyxDQUFDLElBQUEsZUFBUSxFQUFDLHlDQUF5QyxDQUFDLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN0SixNQUFNLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLGlCQUFpQixFQUFFLGVBQWUsQ0FBQyxDQUFBO1FBQ25HLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUM5QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ3JGLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFFdEYsU0FBUztRQUNULE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDakMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNuQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ25DLFVBQVU7UUFDVixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUNuQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ2hELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDdkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ3JDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDOUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUE7UUFDMUQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQTtJQUMxRCxDQUFDLENBQUMsQ0FBQTtJQUVGLEVBQUUsQ0FBQyxzRUFBc0UsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNsRixNQUFNLGdCQUFnQixHQUFHLElBQUksMERBQWtDLENBQUMsSUFBQSxlQUFRLEVBQUMseUNBQXlDLENBQUMsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3RKLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLENBQUMsQ0FBQTtRQUNsRixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ3RGLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQTtJQUNwRCxDQUFDLENBQUMsQ0FBQTtJQUVGLEVBQUUsQ0FBQywwREFBMEQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN0RSxNQUFNLGdCQUFnQixHQUFHLElBQUksb0VBQTRDLENBQUMsSUFBQSxlQUFRLEVBQUMseUNBQXlDLENBQUMsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hLLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLGVBQWUsQ0FBQyxDQUFBO1FBQ3RGLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUM5QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ3JGLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUE7UUFFdEYsU0FBUztRQUNULE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDakMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNuQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ25DLFVBQVU7UUFDVixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUNuQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDdEMsTUFBTSxDQUFDLGdDQUFnQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQzdELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDdkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ3JDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUE7UUFDOUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQyxDQUFBO1FBQ3BELE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUE7SUFDMUQsQ0FBQyxDQUFDLENBQUE7SUFFRixFQUFFLENBQUMscURBQXFELEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDakUsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLDZEQUFxQyxDQUFDLElBQUEsZUFBUSxFQUFDLHlDQUF5QyxDQUFDLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN6SixJQUFJLE9BQU8sR0FBcUI7WUFDNUIsU0FBUyxFQUFFLFdBQVc7U0FDekIsQ0FBQTtRQUNELE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUMzRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDOUIsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQTtRQUNyRixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBRXRGLFNBQVM7UUFDVCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ2pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7UUFDbkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNuQyxVQUFVO1FBQ1YsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUN2QyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDbkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3RDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtRQUNwRCxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQTtRQUNyQyxJQUFJLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNuRixJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFDakQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUN4RCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDI1IEFwcGxlIEluYy4gTGljZW5zZWQgdW5kZXIgTUlUIExpY2Vuc2UuXG5cbmltcG9ydCB7IEFkdmFuY2VkQ29tbWVyY2VJbkFwcFJlcXVlc3QsIEFkdmFuY2VkQ29tbWVyY2VJbkFwcFNpZ25hdHVyZUNyZWF0b3IsIEludHJvZHVjdG9yeU9mZmVyRWxpZ2liaWxpdHlTaWduYXR1cmVDcmVhdG9yLCBQcm9tb3Rpb25hbE9mZmVyVjJTaWduYXR1cmVDcmVhdG9yIH0gZnJvbSBcIi4uLy4uL2p3c19zaWduYXR1cmVfY3JlYXRvclwiO1xuaW1wb3J0IHsgcmVhZEZpbGUgfSBmcm9tIFwiLi4vdXRpbFwiXG5pbXBvcnQganNvbndlYnRva2VuID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG5cbmludGVyZmFjZSBUZXN0SW5BcHBSZXF1ZXN0IGV4dGVuZHMgQWR2YW5jZWRDb21tZXJjZUluQXBwUmVxdWVzdCB7XG4gICAgdGVzdFZhbHVlOiBzdHJpbmdcbn1cblxuZGVzY3JpYmUoXCJKV1MgU2lnbmF0dXJlIENyZWF0b3IgQ2hlY2tzXCIsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhIHByb21vdGlvbmFsIG9mZmVyIHNpZ25hdHVyZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlQ3JlYXRvciA9IG5ldyBQcm9tb3Rpb25hbE9mZmVyVjJTaWduYXR1cmVDcmVhdG9yKHJlYWRGaWxlKCd0ZXN0cy9yZXNvdXJjZXMvY2VydHMvdGVzdFNpZ25pbmdLZXkucDgnKSwgXCJrZXlJZFwiLCBcImlzc3VlcklkXCIsIFwiYnVuZGxlSWRcIik7XG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHNpZ25hdHVyZUNyZWF0b3IuY3JlYXRlU2lnbmF0dXJlKCdwcm9kdWN0SWQnLCAnb2ZmZXJJZGVudGlmaWVyJywgJ3RyYW5zYWN0aW9uSWQnKVxuICAgICAgICBleHBlY3Qoc2lnbmF0dXJlKS50b0JlVHJ1dGh5KClcbiAgICAgICAgbGV0IGhlYWRlciA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20oc2lnbmF0dXJlLnNwbGl0KCcuJylbMF0sICdiYXNlNjR1cmwnKS50b1N0cmluZygpKVxuICAgICAgICBsZXQgcGF5bG9hZCA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20oc2lnbmF0dXJlLnNwbGl0KCcuJylbMV0sICdiYXNlNjR1cmwnKS50b1N0cmluZygpKVxuXG4gICAgICAgIC8vIEhlYWRlclxuICAgICAgICBleHBlY3QoJ0pXVCcpLnRvQmUoaGVhZGVyWyd0eXAnXSlcbiAgICAgICAgZXhwZWN0KCdFUzI1NicpLnRvQmUoaGVhZGVyWydhbGcnXSlcbiAgICAgICAgZXhwZWN0KCdrZXlJZCcpLnRvQmUoaGVhZGVyWydraWQnXSlcbiAgICAgICAgLy8gUGF5bG9hZFxuICAgICAgICBleHBlY3QoJ2lzc3VlcklkJykudG9CZShwYXlsb2FkWydpc3MnXSlcbiAgICAgICAgZXhwZWN0KHBheWxvYWRbJ2lhdCddKS50b0JlVHJ1dGh5KClcbiAgICAgICAgZXhwZWN0KHBheWxvYWRbJ2V4cCddKS50b0JlVW5kZWZpbmVkKClcbiAgICAgICAgZXhwZWN0KCdwcm9tb3Rpb25hbC1vZmZlcicpLnRvQmUocGF5bG9hZFsnYXVkJ10pXG4gICAgICAgIGV4cGVjdCgnYnVuZGxlSWQnKS50b0JlKHBheWxvYWRbJ2JpZCddKVxuICAgICAgICBleHBlY3QocGF5bG9hZFsnbm9uY2UnXSkudG9CZVRydXRoeSgpXG4gICAgICAgIGV4cGVjdCgncHJvZHVjdElkJykudG9CZShwYXlsb2FkWydwcm9kdWN0SWQnXSlcbiAgICAgICAgZXhwZWN0KCdvZmZlcklkZW50aWZpZXInKS50b0JlKHBheWxvYWRbJ29mZmVySWRlbnRpZmllciddKVxuICAgICAgICBleHBlY3QoJ3RyYW5zYWN0aW9uSWQnKS50b0JlKHBheWxvYWRbJ3RyYW5zYWN0aW9uSWQnXSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBwcm9tb3Rpb25hbCBvZmZlciBzaWduYXR1cmUgd2l0aG91dCBhIHRyYW5zYWN0aW9uIGlkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBzaWduYXR1cmVDcmVhdG9yID0gbmV3IFByb21vdGlvbmFsT2ZmZXJWMlNpZ25hdHVyZUNyZWF0b3IocmVhZEZpbGUoJ3Rlc3RzL3Jlc291cmNlcy9jZXJ0cy90ZXN0U2lnbmluZ0tleS5wOCcpLCBcImtleUlkXCIsIFwiaXNzdWVySWRcIiwgXCJidW5kbGVJZFwiKTtcbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gc2lnbmF0dXJlQ3JlYXRvci5jcmVhdGVTaWduYXR1cmUoJ3Byb2R1Y3RJZCcsICdvZmZlcklkZW50aWZpZXInKVxuICAgICAgICBsZXQgcGF5bG9hZCA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20oc2lnbmF0dXJlLnNwbGl0KCcuJylbMV0sICdiYXNlNjR1cmwnKS50b1N0cmluZygpKVxuICAgICAgICBleHBlY3QocGF5bG9hZFsndHJhbnNhY3Rpb25JZCddKS50b0JlVW5kZWZpbmVkKClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSBpbnRyb2R1Y3RvcnkgZWxpZ2liaWxpdHkgb2ZmZXIgc2lnbmF0dXJlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBzaWduYXR1cmVDcmVhdG9yID0gbmV3IEludHJvZHVjdG9yeU9mZmVyRWxpZ2liaWxpdHlTaWduYXR1cmVDcmVhdG9yKHJlYWRGaWxlKCd0ZXN0cy9yZXNvdXJjZXMvY2VydHMvdGVzdFNpZ25pbmdLZXkucDgnKSwgXCJrZXlJZFwiLCBcImlzc3VlcklkXCIsIFwiYnVuZGxlSWRcIik7XG4gICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHNpZ25hdHVyZUNyZWF0b3IuY3JlYXRlU2lnbmF0dXJlKCdwcm9kdWN0SWQnLCB0cnVlLCAndHJhbnNhY3Rpb25JZCcpXG4gICAgICAgIGV4cGVjdChzaWduYXR1cmUpLnRvQmVUcnV0aHkoKVxuICAgICAgICBsZXQgaGVhZGVyID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbShzaWduYXR1cmUuc3BsaXQoJy4nKVswXSwgJ2Jhc2U2NHVybCcpLnRvU3RyaW5nKCkpXG4gICAgICAgIGxldCBwYXlsb2FkID0gSlNPTi5wYXJzZShCdWZmZXIuZnJvbShzaWduYXR1cmUuc3BsaXQoJy4nKVsxXSwgJ2Jhc2U2NHVybCcpLnRvU3RyaW5nKCkpXG5cbiAgICAgICAgLy8gSGVhZGVyXG4gICAgICAgIGV4cGVjdCgnSldUJykudG9CZShoZWFkZXJbJ3R5cCddKVxuICAgICAgICBleHBlY3QoJ0VTMjU2JykudG9CZShoZWFkZXJbJ2FsZyddKVxuICAgICAgICBleHBlY3QoJ2tleUlkJykudG9CZShoZWFkZXJbJ2tpZCddKVxuICAgICAgICAvLyBQYXlsb2FkXG4gICAgICAgIGV4cGVjdCgnaXNzdWVySWQnKS50b0JlKHBheWxvYWRbJ2lzcyddKVxuICAgICAgICBleHBlY3QocGF5bG9hZFsnaWF0J10pLnRvQmVUcnV0aHkoKVxuICAgICAgICBleHBlY3QocGF5bG9hZFsnZXhwJ10pLnRvQmVVbmRlZmluZWQoKVxuICAgICAgICBleHBlY3QoJ2ludHJvZHVjdG9yeS1vZmZlci1lbGlnaWJpbGl0eScpLnRvQmUocGF5bG9hZFsnYXVkJ10pXG4gICAgICAgIGV4cGVjdCgnYnVuZGxlSWQnKS50b0JlKHBheWxvYWRbJ2JpZCddKVxuICAgICAgICBleHBlY3QocGF5bG9hZFsnbm9uY2UnXSkudG9CZVRydXRoeSgpXG4gICAgICAgIGV4cGVjdCgncHJvZHVjdElkJykudG9CZShwYXlsb2FkWydwcm9kdWN0SWQnXSlcbiAgICAgICAgZXhwZWN0KHRydWUpLnRvQmUocGF5bG9hZFsnYWxsb3dJbnRyb2R1Y3RvcnlPZmZlciddKVxuICAgICAgICBleHBlY3QoJ3RyYW5zYWN0aW9uSWQnKS50b0JlKHBheWxvYWRbJ3RyYW5zYWN0aW9uSWQnXSlcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYW4gQWR2YW5jZWQgQ29tbWVyY2UgaW4gYXBwIHNpZ25hdHVyZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlQ3JlYXRvciA9IG5ldyBBZHZhbmNlZENvbW1lcmNlSW5BcHBTaWduYXR1cmVDcmVhdG9yKHJlYWRGaWxlKCd0ZXN0cy9yZXNvdXJjZXMvY2VydHMvdGVzdFNpZ25pbmdLZXkucDgnKSwgXCJrZXlJZFwiLCBcImlzc3VlcklkXCIsIFwiYnVuZGxlSWRcIik7XG4gICAgICAgIGxldCByZXF1ZXN0OiBUZXN0SW5BcHBSZXF1ZXN0ID0ge1xuICAgICAgICAgICAgdGVzdFZhbHVlOiBcInRlc3RWYWx1ZVwiXG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gc2lnbmF0dXJlQ3JlYXRvci5jcmVhdGVTaWduYXR1cmUocmVxdWVzdClcbiAgICAgICAgZXhwZWN0KHNpZ25hdHVyZSkudG9CZVRydXRoeSgpXG4gICAgICAgIGxldCBoZWFkZXIgPSBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKHNpZ25hdHVyZS5zcGxpdCgnLicpWzBdLCAnYmFzZTY0dXJsJykudG9TdHJpbmcoKSlcbiAgICAgICAgbGV0IHBheWxvYWQgPSBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKHNpZ25hdHVyZS5zcGxpdCgnLicpWzFdLCAnYmFzZTY0dXJsJykudG9TdHJpbmcoKSlcblxuICAgICAgICAvLyBIZWFkZXJcbiAgICAgICAgZXhwZWN0KCdKV1QnKS50b0JlKGhlYWRlclsndHlwJ10pXG4gICAgICAgIGV4cGVjdCgnRVMyNTYnKS50b0JlKGhlYWRlclsnYWxnJ10pXG4gICAgICAgIGV4cGVjdCgna2V5SWQnKS50b0JlKGhlYWRlclsna2lkJ10pXG4gICAgICAgIC8vIFBheWxvYWRcbiAgICAgICAgZXhwZWN0KCdpc3N1ZXJJZCcpLnRvQmUocGF5bG9hZFsnaXNzJ10pXG4gICAgICAgIGV4cGVjdChwYXlsb2FkWydpYXQnXSkudG9CZVRydXRoeSgpXG4gICAgICAgIGV4cGVjdChwYXlsb2FkWydleHAnXSkudG9CZVVuZGVmaW5lZCgpXG4gICAgICAgIGV4cGVjdCgnYWR2YW5jZWQtY29tbWVyY2UtYXBpJykudG9CZShwYXlsb2FkWydhdWQnXSlcbiAgICAgICAgZXhwZWN0KCdidW5kbGVJZCcpLnRvQmUocGF5bG9hZFsnYmlkJ10pXG4gICAgICAgIGV4cGVjdChwYXlsb2FkWydub25jZSddKS50b0JlVHJ1dGh5KClcbiAgICAgICAgbGV0IHBhcnNlZFJlcXVlc3RKc29uID0gQnVmZmVyLmZyb20ocGF5bG9hZFsncmVxdWVzdCddLCAnYmFzZTY0JykudG9TdHJpbmcoJ3V0Zi04JylcbiAgICAgICAgbGV0IHBhcnNlZFJlcXVlc3QgPSBKU09OLnBhcnNlKHBhcnNlZFJlcXVlc3RKc29uKVxuICAgICAgICBleHBlY3QocGFyc2VkUmVxdWVzdFsndGVzdFZhbHVlJ10pLnRvQmUoJ3Rlc3RWYWx1ZScpXG4gICAgfSlcbn0pIl19